{% extends "base.html" %}

{% set title="Files" %}
{% block title %} {{title}} {% endblock %}


{% block styles %}

{{ super() }}

{% for style in assets.styles %}
{{style}}
{% endfor %}

{% endblock %}


{% block scripts %}

{{ super() }}

{% for script in assets.scripts %}
{{script}}
{% endfor %}


<script type="text/javascript">
    require(["jquery","use!backbone","use!underscore", "use!DataTables"],
    function($, Backbone, _, DataTables){

        // Setup table.
        var dataTable = $('.files-table').dataTable({
            sDom: 't',
            aoColumnDefs: [
                {
                    aTargets: ['actions'],
                    bSortable: false
                }
            ],
            bPaginate: false,
            bAutoWidth: false
        });

        // Setup action handlers.
        var actionHandlers = {
            delete: function(file_id, tr){
                var url = '{{ url_for('.delete_file', file_id=-99999) }}';
                url = url.replace('-99999', file_id);
                var deferred = $.ajax({
                    url: url,
                    type: 'DELETE',
                });

                deferred.then(function(){
                    // Remove the row.
                    $(tr).fadeOut(750, function(){
                        setTimeout(500, function(){
                            dataTable.fnDeleteRow(tr);
                        });
                    });
                });

                deferred.fail(function(){
                    // Handle errors.
                    console.log("delete error");
                });
            }
        };


        $('.action-link').on('click', function(event){
            var $link = $(event.delegateTarget);
            var $row = $link.closest('tr');

            var action = $link.data('action_id');
            var row_id = $row.data('row_id');

            var handler = actionHandlers[action];
            if (handler){
                handler(row_id, $row.get(0));
            }
        });
    });
</script>

{% endblock %}


{% block content %}
{{ super() }}

<div class="sasi-files-file-list">
    <div class="inner">
        <h2 class="header">{{title}}</h2>
        <div class="body">
            <div class="inner">

                <div class="file-table-container">
                    <table class="file-table">
                        <thead>
                            <th class="name">Name</th>
                            <th class="actions">Actions</th>
                        </thead>
                        <tbody>
                            {% for file_dict in file_dicts %}
                            <tr data-row_id="{{file_dict['id']}}">
                                <td class="name-cell">
                                    <div class="inner">
                                        {{file_dict['filename']}}
                                    </div>
                                </td>
                                <td class="actions-cell">
                                    <div class="inner">
                                        {% for action in actions %}
                                        <div class="action {{action.id}}">
                                            <a class="action-link" href="javascript:{}" data-action_id="{{action.id}}">
                                                <div class="action-icon {{action.id}}"></div>
                                                <div class="action-text">{{action.label}}</div>
                                            </a>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
