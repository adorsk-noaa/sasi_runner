{% extends "base.html" %}

{% set title="Files" %}
{% block title %} {{title}} {% endblock %}


{% block styles %}

{{ super() }}

{% for style in assets.styles %}
{{style}}
{% endfor %}

{% endblock %}


{% block scripts %}

{{ super() }}

{% for script in assets.scripts %}
{{script}}
{% endfor %}


<script type="text/javascript">
    require(["jquery","use!backbone","use!underscore", "use!DataTables", "use!qtip", "Util"],
    function($, Backbone, _, DataTables, qtip, Util){

        $(document).ready(function(){


        // Setup table.
        var $fileTable = $('.file-table');
        var dataTable = $fileTable.dataTable({
            sDom: 't',
            aoColumnDefs: [
                {
                    aTargets: ['name'],
                },
                {
                    aTargets: ['size'],
                    fnRender: function(o, value){
                        return Util.util.friendlyBytes(value);
                    },
                    sType: 'numeric'
                },
                {
                    aTargets: ['category'],
                },
                {
                    aTargets: ['created'],
                    fnRender: function(o, value){
                        return new Date(value).toLocaleString();
                    },
                    sType: 'date'
                },
                {
                    aTargets: ['actions'],
                    bSortable: false
                }
            ],
            bPaginate: false,
            bAutoWidth: false
        });

        $fileTable.css('visibility', 'visible');

        // Setup action handlers.
        var actionHandlers = {
            delete: function(file_id, tr, $launcher){
                var url = '{{ url_for('.delete_file', file_id=-99999) }}';
                url = url.replace('-99999', file_id);
                var deferred = $.ajax({
                    url: url,
                    type: 'DELETE',
                });

                deferred.then(function(){
                    // Remove the row.
                    $(tr).fadeOut(750, function(){
                        setTimeout(500, function(){
                            dataTable.fnDeleteRow(tr);
                        });
                    });
                });

                deferred.fail(function(jqXHR, textStatus, errorThrown){
                    $launcher.qtip({
                        content: {
                            text: '<div><div>Error, could not delete file: </div>' 
                            + '<div>' + jqXHR.responseText + '</div></div>'
                        },
                        position: {
                            viewport: $(window)
                        },
                        show: {
                            event: 'click',
                            ready: true
                        },
                        hide: {
                            event: 'unfocus',
                        },

                    });
                });
            },
        };

        $('.action-link').on('click', function(event){
            var $link = $(event.delegateTarget);
            var $row = $link.closest('tr');

            var action = $link.data('action_id');
            var row_id = $row.data('row_id');

            var handler = actionHandlers[action];
            if (handler){
                handler(row_id, $row.get(0), $link);
            }
        });

        });
    });
</script>

{% endblock %}


{% block content %}
{{ super() }}

<div class="sasi-file-list-files">
    <div class="inner">
        <h2 class="header">{{title}}</h2>
        <div class="body">
            <div class="inner">

                <div class="file-table-container">
                    <table class="file-table" style="visibility: hidden;">
                        <thead>
                            <th class="name">Name</th>
                            <th class="category">Category</th>
                            <th class="size">Size</th>
                            <th class="created">Created</th>
                            <th class="actions">Actions</th>
                        </thead>
                        <tbody>
                            {% for file_dict in file_dicts %}
                            <tr class="file-row" data-row_id="{{file_dict['id']}}">
                                <td class="{{attr}}-filename">
                                    <a href="{{file_dict['url']}}">{{file_dict['filename']}}</a>
                                </td>
                                {% for attr in [
                                'category',
                                'size',
                                'created'
                                ] %}
                                <td class="{{attr}}-cell">
                                    {{file_dict[attr]}}
                                </td>
                                {% endfor %}
                                <td class="actions-cell">
                                    {% for action in [{'id': 'delete', 'label': 'delete'}] %}
                                    <div class="action {{action.id}}">
                                        <a class="action-link" href="javascript:{}" data-action_id="{{action.id}}">
                                            <div class="action-icon {{action.id}}"></div>
                                            <div class="action-text">{{action.label}}</div>
                                        </a>
                                    </div>
                                    {% endfor %}
                                    {# download action is just a link #}
                                    <div class="action download">
                                        <a class="action-link" href="{{file_dict['url']}}" data-action_id="download">
                                            <div class="action-icon download"></div>
                                            <div class="action-text">download</div>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
